{
  "permissions": {
    "allow": [
      "WebSearch",
      "WebFetch(domain:github.com)",
      "WebFetch(domain:nixos.wiki)",
      "WebFetch(domain:nix.dev)",
      "WebFetch(domain:mynixos.com)",
      "WebFetch(domain:ryantm.github.io)",
      "WebFetch(domain:raw.githubusercontent.com)",
      "WebFetch(domain:sekun.net)",
      "Bash(curl:*)",
      "Bash(python3:*)",
      "WebFetch(domain:api.github.com)",
      "WebFetch(domain:flake.parts)",
      "Bash(nix:*)",
      "Bash(gh release list:*)",
      "Bash(nix-shell -p jq --run 'jq -r \"\".[] | select\\(.prerelease == false\\) | .tag_name\"\" | head -10')",
      "Bash(nix-prefetch-url:*)",
      "Bash(nix-shell:*)",
      "Bash(git add:*)",
      "Bash(jj status:*)",
      "Bash(jj diff:*)",
      "Bash(jj log:*)",
      "Bash(jj commit -m \"$\\(cat <<''EOF''\nAdd Nix flake for Azure DevOps Pipelines agent\n\nPackage the Azure DevOps Pipelines self-hosted agent \\(v4.268.0\\) as a\nNix derivation with autoPatchelfHook for prebuilt .NET binaries, and\nprovide a NixOS module for running it as a systemd service.\n\n- flake.nix: flake-parts based, x86_64-linux + aarch64-linux\n- package.nix: fetchurl from Azure CDN, autoPatchelfHook, wrapper scripts\n- module.nix: services.azure-pipelines-agent.instances.<name> with PAT auth,\n  extraPackages, systemd hardening\nEOF\n\\)\")",
      "Bash(OUT=/nix/store/6sag3rnbgnkwkybsxwdcgn130khr9xnj-azure-pipelines-agent-4.268.0)",
      "Bash(ldd:*)",
      "Bash(patchelf:*)",
      "Bash(OUT=/nix/store/2a70k813jk2p2jnvssyszlspai9c3c4w-azure-pipelines-agent-4.268.0)",
      "WebFetch(domain:www.nuget.org)",
      "WebFetch(domain:pkgs.dev.azure.com)",
      "WebFetch(domain:www.myget.org)",
      "WebFetch(domain:wiki.nixos.org)",
      "Bash(gh api:*)",
      "Bash(/home/ergotu/Documents/Projects/ado-agent-flake/patches/agent-root-knob.patch << 'ENDOFPATCH'\ndiff --git a/src/Agent.Sdk/Knob/AgentKnobs.cs b/src/Agent.Sdk/Knob/AgentKnobs.cs\n--- a/src/Agent.Sdk/Knob/AgentKnobs.cs\n+++ b/src/Agent.Sdk/Knob/AgentKnobs.cs\n@@ -79,3 +79,10 @@\n             new BuiltInDefaultKnobSource\\(string.Empty\\)\\);\n \n+        public static readonly Knob AgentRootDirectory = new Knob\\(\n+            nameof\\(AgentRootDirectory\\),\n+            \"The root directory for the agent. Overrides the default \\(parent of binary directory\\).\",\n+            new EnvironmentKnobSource\\(\"AGENT_ROOT\"\\),\n+            new BuiltInDefaultKnobSource\\(string.Empty\\)\\);\n+\n         public static readonly Knob OverwriteTemp = new Knob\\(\ndiff --git a/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs b/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n--- a/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n+++ b/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n@@ -234,7 +234,7 @@\n \n                 case WellKnownDirectory.Externals:\n                     path = Path.Combine\\(\n-                        GetDirectory\\(WellKnownDirectory.Root\\),\n+                        new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName,\n                         Constants.Path.ExternalsDirectory\\);\n                     break;\n \n@@ -252,3 +252,8 @@\n                 case WellKnownDirectory.Root:\n-                    path = new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName;\n+                    path = AgentKnobs.AgentRootDirectory.GetValue\\(this\\).AsString\\(\\);\n+                    if \\(string.IsNullOrEmpty\\(path\\)\\)\n+                    {\n+                        path = new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName;\n+                    }\n                     break;\n@@ -362,5 +362,10 @@\n             }\n \n-            return Path.Combine\\(\n-                new DirectoryInfo\\(Path.GetDirectoryName\\(Assembly.GetEntryAssembly\\(\\).Location\\)\\).Parent.FullName,\n-                Constants.Path.DiagDirectory\\);\n+            var agentRoot = Environment.GetEnvironmentVariable\\(\"AGENT_ROOT\"\\);\n+            if \\(string.IsNullOrEmpty\\(agentRoot\\)\\)\n+            {\n+                agentRoot = new DirectoryInfo\\(Path.GetDirectoryName\\(Assembly.GetEntryAssembly\\(\\).Location\\)\\).Parent.FullName;\n+            }\n+\n+            return Path.Combine\\(agentRoot, Constants.Path.DiagDirectory\\);\n         }\nENDOFPATCH)",
      "Bash(/home/ergotu/Documents/Projects/ado-agent-flake/patches/agent-root-knob.patch << 'ENDOFPATCH'\ndiff --git a/src/Agent.Sdk/Knob/AgentKnobs.cs b/src/Agent.Sdk/Knob/AgentKnobs.cs\n--- a/src/Agent.Sdk/Knob/AgentKnobs.cs\n+++ b/src/Agent.Sdk/Knob/AgentKnobs.cs\n@@ -79,3 +79,9 @@\n             new BuiltInDefaultKnobSource\\(string.Empty\\)\\);\n \n+        public static readonly Knob AgentRootDirectory = new Knob\\(\n+            nameof\\(AgentRootDirectory\\),\n+            \"The root directory for the agent. Overrides the default \\(parent of binary directory\\).\",\n+            new EnvironmentKnobSource\\(\"AGENT_ROOT\"\\),\n+            new BuiltInDefaultKnobSource\\(string.Empty\\)\\);\n+\n         public static readonly Knob OverwriteTemp = new Knob\\(\ndiff --git a/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs b/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n--- a/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n+++ b/src/Microsoft.VisualStudio.Services.Agent/HostContext.cs\n@@ -234,7 +234,7 @@\n \n                 case WellKnownDirectory.Externals:\n                     path = Path.Combine\\(\n-                        GetDirectory\\(WellKnownDirectory.Root\\),\n+                        new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName,\n                         Constants.Path.ExternalsDirectory\\);\n                     break;\n \n@@ -252,3 +252,7 @@\n                 case WellKnownDirectory.Root:\n-                    path = new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName;\n+                    path = AgentKnobs.AgentRootDirectory.GetValue\\(this\\).AsString\\(\\);\n+                    if \\(string.IsNullOrEmpty\\(path\\)\\)\n+                    {\n+                        path = new DirectoryInfo\\(GetDirectory\\(WellKnownDirectory.Bin\\)\\).Parent.FullName;\n+                    }\n                     break;\n@@ -362,6 +362,10 @@\n             }\n \n-            return Path.Combine\\(\n-                new DirectoryInfo\\(Path.GetDirectoryName\\(Assembly.GetEntryAssembly\\(\\).Location\\)\\).Parent.FullName,\n-                Constants.Path.DiagDirectory\\);\n+            var agentRoot = Environment.GetEnvironmentVariable\\(\"AGENT_ROOT\"\\);\n+            if \\(string.IsNullOrEmpty\\(agentRoot\\)\\)\n+            {\n+                agentRoot = new DirectoryInfo\\(Path.GetDirectoryName\\(Assembly.GetEntryAssembly\\(\\).Location\\)\\).Parent.FullName;\n+            }\n+\n+            return Path.Combine\\(agentRoot, Constants.Path.DiagDirectory\\);\n         }\nENDOFPATCH)",
      "Bash(jj describe:*)"
    ]
  }
}
